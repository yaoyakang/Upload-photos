<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>多图片压缩上传</title>
    <script src="jquery-1.9.1.js"></script>
</head>
<body>

<div id="z_photos">
    <input type="file" name="file" onchange="inputMore(this)" id="file" class="file" value=""
           accept="image/jpg,image/jpeg,image/png,image/bmp"
           multiple="multiple"/>
</div>

<script>
    function convertimgtobase64(url, callback, outputformat) {
        var canvas = document.createelement('canvas');
        var ctx = canvas.getcontext('2d');
        var img = new image;
        img.crossorigin = 'anonymous';
        img.onload = function () {
            var width = img.width;
            var height = img.height;
            // 按比例压缩4倍
//            var rate = (width<height ? width/height : height/width)/1;
            canvas.width = width;
            canvas.height = height;
            ctx.drawimage(img, 0, 0, width, height, 0, 0, width, height);
            var dataurl = canvas.todataurl(outputformat || 'image/jpeg', 0.5);
            callback.call(this, dataurl);
            canvas = null;
        };
        img.src = url;

    }

    function getobjecturl(file) {
        var url = null;
        if (window.createobjecturl != undefined) {  // basic
            url = window.createobjecturl(file);
        } else if (window.url != undefined) {       // mozilla(firefox)
            url = window.url.createobjecturl(file);
        } else if (window.webkiturl != undefined) { // web_kit or chrome
            url = window.webkiturl.createobjecturl(file);
        }
        return url;
    }

    function clacimgzoomparam(maxwidth, maxheight, width, height) {
        var param = {
            top: 0,
            left: 0,
            width: width,
            height: height
        };
        if (width > maxwidth || height > maxheight) {
            ratewidth = width / maxwidth;
            rateheight = height / maxheight;

            if (ratewidth > rateheight) {
                param.width = maxwidth;
                param.height = math.round(height / ratewidth);
            } else {
                param.width = math.round(width / rateheight);
                param.height = maxheight;
            }
        }
        param.left = math.round((maxwidth - param.width) / 2);
        param.top = math.round((maxheight - param.height) / 2);
        return param;
    }

    function inputmore(obj) {
        var filelist = obj.files;
        if ($(".addbox").length + filelist.length > 5) {
            alert("你选择的图片不能超过5个")
        } else {
            for (var i = 0; i < filelist.length; i++) {
                var imageurl = getobjecturl(filelist[i]);
                convertimgtobase64(imageurl, function (base64img) {
                    var maxwidth = 90;
                    var maxheight = 90;
                    var adddom = $("<div class='addbox'></div>")
                    $("#z_photos").append(adddom)
                    var img = $("<img />")
                    img.attr("src", base64img)
                    adddom.append(img)
                    var addinput = $("<input type='hidden' />");
                    addinput.val(base64img)
                    adddom.append(addinput)
                    var icon = $("<img  class='addicon' src='a7.png'/>")
                    adddom.append(icon)
                    img.onload = function () {
                        var maxwidth = 90;
                        var maxheight = 90;
                        var rect = clacimgzoomparam(maxwidth, maxheight, img.offsetwidth, img.offsetheight);
                        img.width = rect.width;
                        img.height = rect.height;
                    }
                }, 'image/jpeg');
                event.preventdefault();
            }
        }

    }

    $("#z_photos").on("click", ".addicon", function () {
        $(this).parent().remove()
    })
</script>
</body>
</html>